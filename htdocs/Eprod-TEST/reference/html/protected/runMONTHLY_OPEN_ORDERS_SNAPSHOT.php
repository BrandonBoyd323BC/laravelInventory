<?php
	$DEBUG = 0;

	if (isset($_POST["debug"])) {
		$DEBUG = $_POST["debug"];
	}

	require_once("procfile.php");

	$retval = ConnectToDatabaseServer($DBServer, $db);
	if ($retval == 0) {
		error_log("runMONTHLY_OPEN_ORDERS_SNAPSHOT cannot connect to database");
	} else {
		$retval = SelectDatabase($dbName);
		if ($retval == 0) {
			error_log("runMONTHLY_OPEN_ORDERS_SNAPSHOT cannot select " . $dbName);
		} else {
			error_log("#############################################");
			error_log("### runMONTHLY_OPEN_ORDERS_SNAPSHOT started at " . date('Y-m-d g:i:s a'));
			error_log("### runMONTHLY_OPEN_ORDERS_SNAPSHOT CHECKING flag in RUNNING_PROC " . date('Y-m-d g:i:s a'));

			$sql  = "SELECT * ";
			$sql .= " FROM nsa.RUNNING_PROC ";
			$sql .= " WHERE PROC_NAME = 'runMONTHLY_OPEN_ORDERS_SNAPSHOT' ";
			$sql .= " and FLAG_RUNNING = '1' ";
			$sql .= " and DATE_EXP > getDate()";
			QueryDatabase($sql, $results);

			if (mssql_num_rows($results) == 0) {
				$sql  = "INSERT INTO nsa.RUNNING_PROC( ";
				$sql .= " PROC_NAME, ";
				$sql .= " FLAG_RUNNING, ";
				$sql .= " DATE_ADD, ";
				$sql .= " DATE_EXP ";
				$sql .= ") VALUES ( ";
				$sql .= "'runMONTHLY_OPEN_ORDERS_SNAPSHOT', ";
				$sql .= "1, ";
				$sql .= " getDate(), ";
				$sql .= " dateadd(minute,5,getDate()) ";
				$sql .= ")  SELECT LAST_INSERT_ID=@@IDENTITY";
				QueryDatabase($sql, $results);
				$row = mssql_fetch_assoc($results);
				$ProcRowID = $row['LAST_INSERT_ID'];
				error_log("### runMONTHLY_OPEN_ORDERS_SNAPSHOT SETTING flag in RUNNING_PROC " . date('Y-m-d g:i:s a'));
				error_log("### LAST INSERT ID: " . $ProcRowID);

				$sql = "SET ANSI_NULLS ON";
				QueryDatabase($sql, $results);
				$sql = "SET ANSI_WARNINGS ON";
				QueryDatabase($sql, $results);
				$sql = "SET QUOTED_IDENTIFIER OFF";
				QueryDatabase($sql, $results);
				$sql = "SET ANSI_PADDING ON";
				QueryDatabase($sql, $results);
				$sql = "SET CONCAT_NULL_YIELDS_NULL ON";
				QueryDatabase($sql, $results);
				$sql = "SET CONCAT_NULL_YIELDS_NULL OFF";
				QueryDatabase($sql, $results);
				//ini_set('memory_limit', '-1');



				//$arrayDates = array("20170601","20170701","20170801","20170901","20171001","20171101","20171201","20180101","20180201","20180301","20180401","20180501","20180601","20180701","20180801","20180901","20181001");

				//$arrlength=count($arrayDates);
				//for($x=0;$x<$arrlength;$x++) {
					error_log("### runMONTHLY_OPEN_ORDERS_SNAPSHOT CAPTURING CP_ORDHDR ");
					$sql = " INSERT INTO nsa.CP_ORDHDR_SNAPSHOTS (";
					$sql .= " [ID_ORD], ";
					$sql .= " [ID_CUST_SOLDTO], ";
					$sql .= " [SEQ_SHIPTO], ";
					$sql .= " [ID_PO_CUST], ";
					$sql .= " [DATE_ADD], ";
					$sql .= " [TIME_ADD], ";
					$sql .= " [ID_USER_ADD], ";
					$sql .= " [DATE_CHG], ";
					$sql .= " [TIME_CHG], ";
					$sql .= " [ID_USER_CHG], ";
					$sql .= " [TYPE_ORD_CP], ";
					$sql .= " [ID_CUST_BILLTO], ";
					$sql .= " [NAME_CUST], ";
					$sql .= " [NAME_CUST_SHIPTO], ";
					$sql .= " [ADDR_1], ";
					$sql .= " [ADDR_2], ";
					$sql .= " [ADDR_3], ";
					$sql .= " [ADDR_4], ";
					$sql .= " [CITY], ";
					$sql .= " [ID_ST], ";
					$sql .= " [ZIP], ";
					$sql .= " [PROV], ";
					$sql .= " [COUNTRY], ";
					$sql .= " [ID_REV], ";
					$sql .= " [VER_BO], ";
					$sql .= " [CODE_STAT_ORD], ";
					$sql .= " [NAME_ORD_BY], ";
					$sql .= " [ID_SLSREP_1], ";
					$sql .= " [ID_SLSREP_2], ";
					$sql .= " [ID_SLSREP_3], ";
					$sql .= " [PCT_SPLIT_COMMSN_1], ";
					$sql .= " [PCT_SPLIT_COMMSN_2], ";
					$sql .= " [PCT_SPLIT_COMMSN_3], ";
					$sql .= " [PCT_COMMSN], ";
					$sql .= " [AMT_COMMSN], ";
					$sql .= " [AMT_COMMSN_FC], ";
					$sql .= " [PCT_DISC_ORD_1], ";
					$sql .= " [PCT_DISC_ORD_2], ";
					$sql .= " [PCT_DISC_ORD_3], ";
					$sql .= " [ID_QUOTE], ";
					$sql .= " [SEQ_REV_QUOTE], ";
					$sql .= " [FLAG_QUOTE_ORG], ";
					$sql .= " [ID_JOB], ";
					$sql .= " [DATE_ORD], ";
					$sql .= " [DATE_USER], ";
					$sql .= " [DATE_ACKN_LAST], ";
					$sql .= " [DATE_PICK_LAST], ";
					$sql .= " [DATE_BOL_LAST], ";
					$sql .= " [DATE_SHIP_LAST], ";
					$sql .= " [DATE_INVC_LAST], ";
					$sql .= " [DATE_BOOK_LAST], ";
					$sql .= " [CODE_USER], ";
					$sql .= " [CODE_CUST_1], ";
					$sql .= " [CODE_CUST_2], ";
					$sql .= " [CODE_CUST_3], ";
					$sql .= " [LEVEL_INVC], ";
					$sql .= " [CODE_SHIP_VIA_CP], ";
					$sql .= " [DESCR_SHIP_VIA], ";
					$sql .= " [CODE_TRMS_CP], ";
					$sql .= " [DESCR_TRMS], ";
					$sql .= " [PCT_DISC_TRMS], ";
					$sql .= " [AMT_DISC], ";
					$sql .= " [CODE_COL_PPD], ";
					$sql .= " [DESCR_COL_PPD], ";
					$sql .= " [CODE_FOB_CP], ";
					$sql .= " [DESCR_FOB], ";
					$sql .= " [CODE_AUTH_TAX_1], ";
					$sql .= " [CODE_AUTH_TAX_2], ";
					$sql .= " [CODE_AUTH_TAX_3], ";
					$sql .= " [CODE_AUTH_TAX_4], ";
					$sql .= " [CODE_EXMT_TAX_1], ";
					$sql .= " [CODE_EXMT_TAX_2], ";
					$sql .= " [CODE_EXMT_TAX_3], ";
					$sql .= " [CODE_EXMT_TAX_4], ";
					$sql .= " [AMT_ORD_TOTAL], ";
					$sql .= " [AMT_ORD_TOTAL_FC], ";
					$sql .= " [ACCT_SUBID_AR], ";
					$sql .= " [ACCT_ID_AR], ";
					$sql .= " [ACCT_DIV_AR], ";
					$sql .= " [ACCT_LOC_AR], ";
					$sql .= " [ACCT_DEPT_AR], ";
					$sql .= " [ACCT_SUBID_CHRG_MISC], ";
					$sql .= " [ACCT_ID_CHRG_MISC], ";
					$sql .= " [ACCT_DIV_CHRG_MISC], ";
					$sql .= " [ACCT_LOC_CHRG_MISC], ";
					$sql .= " [ACCT_DEPT_CHRG_MISC], ";
					$sql .= " [ACCT_SUBID_DEP], ";
					$sql .= " [ACCT_ID_DEP], ";
					$sql .= " [ACCT_DIV_DEP], ";
					$sql .= " [ACCT_LOC_DEP], ";
					$sql .= " [ACCT_DEPT_DEP], ";
					$sql .= " [ACCT_SUBID_FRT], ";
					$sql .= " [ACCT_ID_FRT], ";
					$sql .= " [ACCT_DIV_FRT], ";
					$sql .= " [ACCT_LOC_FRT], ";
					$sql .= " [ACCT_DEPT_FRT], ";
					$sql .= " [ACCT_SUBID_TAX], ";
					$sql .= " [ACCT_ID_TAX], ";
					$sql .= " [ACCT_DIV_TAX], ";
					$sql .= " [ACCT_LOC_TAX], ";
					$sql .= " [ACCT_DEPT_TAX], ";
					$sql .= " [AMT_DEP], ";
					$sql .= " [AMT_DEP_FC], ";
					$sql .= " [ID_DOC_APPLYTO], ";
					$sql .= " [COST_TOTAL], ";
					$sql .= " [COST_TOTAL_FC], ";
					$sql .= " [FLAG_ACKN], ";
					$sql .= " [FLAG_PICK], ";
					$sql .= " [FLAG_INVC], ";
					$sql .= " [FLAG_BOL], ";
					$sql .= " [ID_ORD_LAST], ";
					$sql .= " [ID_INVC_LAST], ";
					$sql .= " [ID_SHIP_LAST], ";
					$sql .= " [ID_PRO_BOL_LAST], ";
					$sql .= " [DESCR_SHIP_VIA_LAST], ";
					$sql .= " [ID_LOC_SHIPFM], ";
					$sql .= " [ID_SESS_ORD], ";
					$sql .= " [ID_USER_ORD], ";
					$sql .= " [FLAG_PRNT_OPTION_PRICE], ";
					$sql .= " [QTY_SHIP_OUTST], ";
					$sql .= " [ID_TERR], ";
					$sql .= " [FLAG_ASN_EDI], ";
					$sql .= " [FLAG_INVC_EDI], ";
					$sql .= " [ID_TP], ";
					$sql .= " [ID_DIV_TP], ";
					$sql .= " [ID_DEST_TP_BILLTO], ";
					$sql .= " [CODE_SRC_EDI], ";
					$sql .= " [ID_REL], ";
					$sql .= " [ID_DEST_TP_SHIPTO], ";
					$sql .= " [FLAG_810], ";
					$sql .= " [ID_SHIP_BOL], ";
					$sql .= " [ABBRV_CONSIG], ";
					$sql .= " [CODE_DOCK], ";
					$sql .= " [FLAG_CHK_AVAIL], ";
					$sql .= " [CODE_CRNCY], ";
					$sql .= " [RATE_EXCHG_CRNCY], ";
					$sql .= " [ID_USER_MNT_ORD], ";
					$sql .= " [SEQ_LINE_LAST], ";
					$sql .= " [ATTACH_COMMENT], ";
					$sql .= " [FLAG_TAX_SHIP], ";
					$sql .= " [WGT_TOTAL], ";
					$sql .= " [SUFX_DOC_APPLYTO], ";
					$sql .= " [AMT_FEE_RESTOCK], ";
					$sql .= " [AMT_FEE_RESTOCK_FC], ";
					$sql .= " [ACCT_SUBID_FEE_RESTOCK], ";
					$sql .= " [ACCT_ID_FEE_RESTOCK], ";
					$sql .= " [ACCT_DIV_FEE_RESTOCK], ";
					$sql .= " [ACCT_LOC_FEE_RESTOCK], ";
					$sql .= " [ACCT_DEPT_FEE_RESTOCK], ";
					$sql .= " [CODE_TAX_GEO], ";
					$sql .= " [CODE_TAX_PROD_FRT], ";
					$sql .= " [CODE_TAX_PROD_MSC], ";
					$sql .= " [CODE_TAX_PROD_RSTK], ";
					$sql .= " [AMT_FRT], ";
					$sql .= " [TAX_SLS], ";
					$sql .= " [TAX_SLS_FC], ";
					$sql .= " [ADDR_1_TAX], ";
					$sql .= " [ADDR_2_TAX], ";
					$sql .= " [ADDR_3_TAX], ";
					$sql .= " [CITY_TAX], ";
					$sql .= " [REGION_TAX], ";
					$sql .= " [COUNTRY_TAX], ";
					$sql .= " [CODE_POSTAL_TAX], ";
					$sql .= " [ORIG_rowid], ";
					$sql .= " [DATETIME_SNAPSHOT] ";
					$sql .= " ) ";
					$sql .= " SELECT ";
					$sql .= " [ID_ORD], ";
					$sql .= " [ID_CUST_SOLDTO], ";
					$sql .= " [SEQ_SHIPTO], ";
					$sql .= " [ID_PO_CUST], ";
					$sql .= " [DATE_ADD], ";
					$sql .= " [TIME_ADD], ";
					$sql .= " [ID_USER_ADD], ";
					$sql .= " [DATE_CHG], ";
					$sql .= " [TIME_CHG], ";
					$sql .= " [ID_USER_CHG], ";
					$sql .= " [TYPE_ORD_CP], ";
					$sql .= " [ID_CUST_BILLTO], ";
					$sql .= " [NAME_CUST], ";
					$sql .= " [NAME_CUST_SHIPTO], ";
					$sql .= " [ADDR_1], ";
					$sql .= " [ADDR_2], ";
					$sql .= " [ADDR_3], ";
					$sql .= " [ADDR_4], ";
					$sql .= " [CITY], ";
					$sql .= " [ID_ST], ";
					$sql .= " [ZIP], ";
					$sql .= " [PROV], ";
					$sql .= " [COUNTRY], ";
					$sql .= " [ID_REV], ";
					$sql .= " [VER_BO], ";
					$sql .= " [CODE_STAT_ORD], ";
					$sql .= " [NAME_ORD_BY], ";
					$sql .= " [ID_SLSREP_1], ";
					$sql .= " [ID_SLSREP_2], ";
					$sql .= " [ID_SLSREP_3], ";
					$sql .= " [PCT_SPLIT_COMMSN_1], ";
					$sql .= " [PCT_SPLIT_COMMSN_2], ";
					$sql .= " [PCT_SPLIT_COMMSN_3], ";
					$sql .= " [PCT_COMMSN], ";
					$sql .= " [AMT_COMMSN], ";
					$sql .= " [AMT_COMMSN_FC], ";
					$sql .= " [PCT_DISC_ORD_1], ";
					$sql .= " [PCT_DISC_ORD_2], ";
					$sql .= " [PCT_DISC_ORD_3], ";
					$sql .= " [ID_QUOTE], ";
					$sql .= " [SEQ_REV_QUOTE], ";
					$sql .= " [FLAG_QUOTE_ORG], ";
					$sql .= " [ID_JOB], ";
					$sql .= " [DATE_ORD], ";
					$sql .= " [DATE_USER], ";
					$sql .= " [DATE_ACKN_LAST], ";
					$sql .= " [DATE_PICK_LAST], ";
					$sql .= " [DATE_BOL_LAST], ";
					$sql .= " [DATE_SHIP_LAST], ";
					$sql .= " [DATE_INVC_LAST], ";
					$sql .= " [DATE_BOOK_LAST], ";
					$sql .= " [CODE_USER], ";
					$sql .= " [CODE_CUST_1], ";
					$sql .= " [CODE_CUST_2], ";
					$sql .= " [CODE_CUST_3], ";
					$sql .= " [LEVEL_INVC], ";
					$sql .= " [CODE_SHIP_VIA_CP], ";
					$sql .= " [DESCR_SHIP_VIA], ";
					$sql .= " [CODE_TRMS_CP], ";
					$sql .= " [DESCR_TRMS], ";
					$sql .= " [PCT_DISC_TRMS], ";
					$sql .= " [AMT_DISC], ";
					$sql .= " [CODE_COL_PPD], ";
					$sql .= " [DESCR_COL_PPD], ";
					$sql .= " [CODE_FOB_CP], ";
					$sql .= " [DESCR_FOB], ";
					$sql .= " [CODE_AUTH_TAX_1], ";
					$sql .= " [CODE_AUTH_TAX_2], ";
					$sql .= " [CODE_AUTH_TAX_3], ";
					$sql .= " [CODE_AUTH_TAX_4], ";
					$sql .= " [CODE_EXMT_TAX_1], ";
					$sql .= " [CODE_EXMT_TAX_2], ";
					$sql .= " [CODE_EXMT_TAX_3], ";
					$sql .= " [CODE_EXMT_TAX_4], ";
					$sql .= " [AMT_ORD_TOTAL], ";
					$sql .= " [AMT_ORD_TOTAL_FC], ";
					$sql .= " [ACCT_SUBID_AR], ";
					$sql .= " [ACCT_ID_AR], ";
					$sql .= " [ACCT_DIV_AR], ";
					$sql .= " [ACCT_LOC_AR], ";
					$sql .= " [ACCT_DEPT_AR], ";
					$sql .= " [ACCT_SUBID_CHRG_MISC], ";
					$sql .= " [ACCT_ID_CHRG_MISC], ";
					$sql .= " [ACCT_DIV_CHRG_MISC], ";
					$sql .= " [ACCT_LOC_CHRG_MISC], ";
					$sql .= " [ACCT_DEPT_CHRG_MISC], ";
					$sql .= " [ACCT_SUBID_DEP], ";
					$sql .= " [ACCT_ID_DEP], ";
					$sql .= " [ACCT_DIV_DEP], ";
					$sql .= " [ACCT_LOC_DEP], ";
					$sql .= " [ACCT_DEPT_DEP], ";
					$sql .= " [ACCT_SUBID_FRT], ";
					$sql .= " [ACCT_ID_FRT], ";
					$sql .= " [ACCT_DIV_FRT], ";
					$sql .= " [ACCT_LOC_FRT], ";
					$sql .= " [ACCT_DEPT_FRT], ";
					$sql .= " [ACCT_SUBID_TAX], ";
					$sql .= " [ACCT_ID_TAX], ";
					$sql .= " [ACCT_DIV_TAX], ";
					$sql .= " [ACCT_LOC_TAX], ";
					$sql .= " [ACCT_DEPT_TAX], ";
					$sql .= " [AMT_DEP], ";
					$sql .= " [AMT_DEP_FC], ";
					$sql .= " [ID_DOC_APPLYTO], ";
					$sql .= " [COST_TOTAL], ";
					$sql .= " [COST_TOTAL_FC], ";
					$sql .= " [FLAG_ACKN], ";
					$sql .= " [FLAG_PICK], ";
					$sql .= " [FLAG_INVC], ";
					$sql .= " [FLAG_BOL], ";
					$sql .= " [ID_ORD_LAST], ";
					$sql .= " [ID_INVC_LAST], ";
					$sql .= " [ID_SHIP_LAST], ";
					$sql .= " [ID_PRO_BOL_LAST], ";
					$sql .= " [DESCR_SHIP_VIA_LAST], ";
					$sql .= " [ID_LOC_SHIPFM], ";
					$sql .= " [ID_SESS_ORD], ";
					$sql .= " [ID_USER_ORD], ";
					$sql .= " [FLAG_PRNT_OPTION_PRICE], ";
					$sql .= " [QTY_SHIP_OUTST], ";
					$sql .= " [ID_TERR], ";
					$sql .= " [FLAG_ASN_EDI], ";
					$sql .= " [FLAG_INVC_EDI], ";
					$sql .= " [ID_TP], ";
					$sql .= " [ID_DIV_TP], ";
					$sql .= " [ID_DEST_TP_BILLTO], ";
					$sql .= " [CODE_SRC_EDI], ";
					$sql .= " [ID_REL], ";
					$sql .= " [ID_DEST_TP_SHIPTO], ";
					$sql .= " [FLAG_810], ";
					$sql .= " [ID_SHIP_BOL], ";
					$sql .= " [ABBRV_CONSIG], ";
					$sql .= " [CODE_DOCK], ";
					$sql .= " [FLAG_CHK_AVAIL], ";
					$sql .= " [CODE_CRNCY], ";
					$sql .= " [RATE_EXCHG_CRNCY], ";
					$sql .= " [ID_USER_MNT_ORD], ";
					$sql .= " [SEQ_LINE_LAST], ";
					$sql .= " [ATTACH_COMMENT], ";
					$sql .= " [FLAG_TAX_SHIP], ";
					$sql .= " [WGT_TOTAL], ";
					$sql .= " [SUFX_DOC_APPLYTO], ";
					$sql .= " [AMT_FEE_RESTOCK], ";
					$sql .= " [AMT_FEE_RESTOCK_FC], ";
					$sql .= " [ACCT_SUBID_FEE_RESTOCK], ";
					$sql .= " [ACCT_ID_FEE_RESTOCK], ";
					$sql .= " [ACCT_DIV_FEE_RESTOCK], ";
					$sql .= " [ACCT_LOC_FEE_RESTOCK], ";
					$sql .= " [ACCT_DEPT_FEE_RESTOCK], ";
					$sql .= " [CODE_TAX_GEO], ";
					$sql .= " [CODE_TAX_PROD_FRT], ";
					$sql .= " [CODE_TAX_PROD_MSC], ";
					$sql .= " [CODE_TAX_PROD_RSTK], ";
					$sql .= " [AMT_FRT], ";
					$sql .= " [TAX_SLS], ";
					$sql .= " [TAX_SLS_FC], ";
					$sql .= " [ADDR_1_TAX], ";
					$sql .= " [ADDR_2_TAX], ";
					$sql .= " [ADDR_3_TAX], ";
					$sql .= " [CITY_TAX], ";
					$sql .= " [REGION_TAX], ";
					$sql .= " [COUNTRY_TAX], ";
					$sql .= " [CODE_POSTAL_TAX], ";
					$sql .= " [rowid] as ORIG_rowid, ";
					$sql .= " GetDate() as DATETIME_SNAPSHOT ";
					//$sql .= " '".$arrayDates[$x]."' as DATETIME_SNAPSHOT ";
					$sql .= " FROM nsa.CP_ORDHDR";
					//$sql .= "_".$arrayDates[$x];
					QueryDatabase($sql, $results);


					error_log("### runMONTHLY_OPEN_ORDERS_SNAPSHOT CAPTURING CP_ORDLIN ");
					$sql = " INSERT INTO nsa.CP_ORDLIN_SNAPSHOTS (";
					$sql .= " [ID_ORD], ";
					$sql .= " [SEQ_LINE_ORD], ";
					$sql .= " [ID_ITEM], ";
					$sql .= " [ID_LOC], ";
					$sql .= " [ID_LOT], ";
					$sql .= " [DATE_ADD], ";
					$sql .= " [TIME_ADD], ";
					$sql .= " [ID_USER_ADD], ";
					$sql .= " [DATE_CHG], ";
					$sql .= " [TIME_CHG], ";
					$sql .= " [ID_USER_CHG], ";
					$sql .= " [ID_ITEM_CUST], ";
					$sql .= " [ID_ITEM_PRECONFIG], ";
					$sql .= " [ID_PRDTLINE], ";
					$sql .= " [ID_CONFIG], ";
					$sql .= " [DESCR_1], ";
					$sql .= " [DESCR_2], ";
					$sql .= " [CODE_UM_ORD], ";
					$sql .= " [FLAG_PRIOR_LINE_ORD], ";
					$sql .= " [CODE_ACT_INV], ";
					$sql .= " [CODE_CAT_PRDT], ";
					$sql .= " [CODE_USER_1_IM], ";
					$sql .= " [CODE_USER_2_IM], ";
					$sql .= " [BIN_PRIM], ";
					$sql .= " [WGT_ITEM], ";
					$sql .= " [WGT_ITEM_ORIG], ";
					$sql .= " [QTY_CARTON], ";
					$sql .= " [FLAG_TAX_SHIP], ";
					$sql .= " [FLAG_STK], ";
					$sql .= " [FLAG_CNTRL], ";
					$sql .= " [QTY_OPEN], ";
					$sql .= " [QTY_BO], ";
					$sql .= " [QTY_NET_CHG], ";
					$sql .= " [QTY_ORG], ";
					$sql .= " [QTY_BOOK], ";
					$sql .= " [QTY_OPEN_DISPLAY], ";
					$sql .= " [QTY_BO_DISPLAY], ";
					$sql .= " [QTY_REL], ";
					$sql .= " [QTY_OPEN_ADJ], ";
					$sql .= " [QTY_BO_ADJ], ";
					$sql .= " [QTY_SHIP_TOTAL_ADJ], ";
					$sql .= " [QTY_SHIP_LAST], ";
					$sql .= " [QTY_SHIP_TOTAL], ";
					$sql .= " [COST_UNIT_VP], ";
					$sql .= " [COST_UNIT_VP_FC], ";
					$sql .= " [PRICE_LIST_VP], ";
					$sql .= " [PRICE_LIST_VP_FC], ";
					$sql .= " [PRICE_SELL_VP], ";
					$sql .= " [PRICE_SELL_VP_FC], ";
					$sql .= " [PRICE_SELL_NET_VP], ";
					$sql .= " [PRICE_SELL_NET_VP_FC], ";
					$sql .= " [PRICE_NET], ";
					$sql .= " [PRICE_NET_FC], ";
					$sql .= " [AMT_COMMSN], ";
					$sql .= " [AMT_COMMSN_FC], ";
					$sql .= " [PCT_COMMSN_LINE], ";
					$sql .= " [CODE_COMMSN_DSPLY], ";
					$sql .= " [FLAG_MTHD_PRICE], ";
					$sql .= " [PCT_DISC_MARKUP_1_VP], ";
					$sql .= " [PCT_DISC_MARKUP_2_VP], ";
					$sql .= " [PCT_DISC_MARKUP_3_VP], ";
					$sql .= " [DATE_RQST], ";
					$sql .= " [DATE_PROM], ";
					$sql .= " [DATE_BOOK_LAST], ";
					$sql .= " [DATE_CHG_LAST], ";
					$sql .= " [DATE_REL], ";
					$sql .= " [DATE_ACKN_LAST], ";
					$sql .= " [DATE_PICK_LAST], ";
					$sql .= " [DATE_BOL_LAST], ";
					$sql .= " [DATE_SHIP_LAST], ";
					$sql .= " [DATE_INVC_LAST], ";
					$sql .= " [ID_INVC_LAST], ";
					$sql .= " [DESCR_SHIP_VIA_LAST], ";
					$sql .= " [ID_SHIP_LAST], ";
					$sql .= " [ID_PRO_BOL_LAST], ";
					$sql .= " [VER_BO], ";
					$sql .= " [FLAG_ACKN], ";
					$sql .= " [FLAG_PICK], ";
					$sql .= " [ID_PICK_SESS], ";
					$sql .= " [FLAG_INVC], ";
					$sql .= " [FLAG_BOL], ";
					$sql .= " [FLAG_TRACK_BIN], ";
					$sql .= " [FLAG_BM_CAPTURE], ";
					$sql .= " [FLAG_COPY_REVW_SF], ";
					$sql .= " [PRICE_OPTION_TOTAL_VP], ";
					$sql .= " [PRICE_OPTION_TOTAL_VP_FC], ";
					$sql .= " [FLAG_DISC_OPTION], ";
					$sql .= " [COST_OPTION_TOTAL_VP], ";
					$sql .= " [COST_OPTION_TOTAL_VP_FC], ";
					$sql .= " [WGT_OPTION_TOTAL], ";
					$sql .= " [ID_LOC_SO], ";
					$sql .= " [ID_SO], ";
					$sql .= " [SUFX_SO], ";
					$sql .= " [RATIO_STK_PRICE], ";
					$sql .= " [CODE_UM_PRICE], ";
					$sql .= " [RATIO_PRICE_SELL], ";
					$sql .= " [DATE_CUTOFF_ALLOC], ";
					$sql .= " [FLAG_SCHD_SHIP], ";
					$sql .= " [CODE_FRT], ";
					$sql .= " [WGT_SHIP_TOTAL], ";
					$sql .= " [FLAG_POST], ";
					$sql .= " [QTY_CARTON_PER], ";
					$sql .= " [QTY_ALLOC], ";
					$sql .= " [FLAG_CUM_MNT], ";
					$sql .= " [YR_MODEL], ";
					$sql .= " [ID_LINE_PO_EDI], ";
					$sql .= " [ID_PO_CUST_CARAS], ";
					$sql .= " [FLAG_OPTION_ATPIC], ";
					$sql .= " [FLAG_BO], ";
					$sql .= " [PCT_CMPL_ATPIC], ";
					$sql .= " [RATE_EXCHG_CRNCY], ";
					$sql .= " [CODE_CAT_COST], ";
					$sql .= " [REL_830], ";
					$sql .= " [YR_MODEL_ALT], ";
					$sql .= " [CLASS_DEST], ";
					$sql .= " [REF], ";
					$sql .= " [CODE_CONT], ";
					$sql .= " [QTY_CONT_PER], ";
					$sql .= " [QTY_CONT_1], ";
					$sql .= " [QTY_CONT_LAST], ";
					$sql .= " [QTY_CONT_2], ";
					$sql .= " [ID_QUOTE], ";
					$sql .= " [SEQ_REV_QUOTE], ";
					$sql .= " [ID_EST], ";
					$sql .= " [SEQ_JOB], ";
					$sql .= " [ATTACH_COMMENT], ";
					$sql .= " [ORG_ITEM], ";
					$sql .= " [FLAG_LINE_SHIP_FROM], ";
					$sql .= " [CODE_FEE_RESTOCK], ";
					$sql .= " [CALC_FEE_RESTOCK_VP], ";
					$sql .= " [AMT_FEE_RESTOCK], ";
					$sql .= " [AMT_FEE_RESTOCK_FC], ";
					$sql .= " [ID_PO], ";
					$sql .= " [ID_REL_ORD], ";
					$sql .= " [ID_LINE_PO], ";
					$sql .= " [CODE_TAX_PROD_CODE], ";
					$sql .= " [SEQ_QTE_LIN], ";
					$sql .= " [ORIG_rowid], ";
					$sql .= " [DATETIME_SNAPSHOT] ";
					$sql .= " ) ";
					$sql .= " SELECT ";
					$sql .= " [ID_ORD], ";
					$sql .= " [SEQ_LINE_ORD], ";
					$sql .= " [ID_ITEM], ";
					$sql .= " [ID_LOC], ";
					$sql .= " [ID_LOT], ";
					$sql .= " [DATE_ADD], ";
					$sql .= " [TIME_ADD], ";
					$sql .= " [ID_USER_ADD], ";
					$sql .= " [DATE_CHG], ";
					$sql .= " [TIME_CHG], ";
					$sql .= " [ID_USER_CHG], ";
					$sql .= " [ID_ITEM_CUST], ";
					$sql .= " [ID_ITEM_PRECONFIG], ";
					$sql .= " [ID_PRDTLINE], ";
					$sql .= " [ID_CONFIG], ";
					$sql .= " [DESCR_1], ";
					$sql .= " [DESCR_2], ";
					$sql .= " [CODE_UM_ORD], ";
					$sql .= " [FLAG_PRIOR_LINE_ORD], ";
					$sql .= " [CODE_ACT_INV], ";
					$sql .= " [CODE_CAT_PRDT], ";
					$sql .= " [CODE_USER_1_IM], ";
					$sql .= " [CODE_USER_2_IM], ";
					$sql .= " [BIN_PRIM], ";
					$sql .= " [WGT_ITEM], ";
					$sql .= " [WGT_ITEM_ORIG], ";
					$sql .= " [QTY_CARTON], ";
					$sql .= " [FLAG_TAX_SHIP], ";
					$sql .= " [FLAG_STK], ";
					$sql .= " [FLAG_CNTRL], ";
					$sql .= " [QTY_OPEN], ";
					$sql .= " [QTY_BO], ";
					$sql .= " [QTY_NET_CHG], ";
					$sql .= " [QTY_ORG], ";
					$sql .= " [QTY_BOOK], ";
					$sql .= " [QTY_OPEN_DISPLAY], ";
					$sql .= " [QTY_BO_DISPLAY], ";
					$sql .= " [QTY_REL], ";
					$sql .= " [QTY_OPEN_ADJ], ";
					$sql .= " [QTY_BO_ADJ], ";
					$sql .= " [QTY_SHIP_TOTAL_ADJ], ";
					$sql .= " [QTY_SHIP_LAST], ";
					$sql .= " [QTY_SHIP_TOTAL], ";
					$sql .= " [COST_UNIT_VP], ";
					$sql .= " [COST_UNIT_VP_FC], ";
					$sql .= " [PRICE_LIST_VP], ";
					$sql .= " [PRICE_LIST_VP_FC], ";
					$sql .= " [PRICE_SELL_VP], ";
					$sql .= " [PRICE_SELL_VP_FC], ";
					$sql .= " [PRICE_SELL_NET_VP], ";
					$sql .= " [PRICE_SELL_NET_VP_FC], ";
					$sql .= " [PRICE_NET], ";
					$sql .= " [PRICE_NET_FC], ";
					$sql .= " [AMT_COMMSN], ";
					$sql .= " [AMT_COMMSN_FC], ";
					$sql .= " [PCT_COMMSN_LINE], ";
					$sql .= " [CODE_COMMSN_DSPLY], ";
					$sql .= " [FLAG_MTHD_PRICE], ";
					$sql .= " [PCT_DISC_MARKUP_1_VP], ";
					$sql .= " [PCT_DISC_MARKUP_2_VP], ";
					$sql .= " [PCT_DISC_MARKUP_3_VP], ";
					$sql .= " [DATE_RQST], ";
					$sql .= " [DATE_PROM], ";
					$sql .= " [DATE_BOOK_LAST], ";
					$sql .= " [DATE_CHG_LAST], ";
					$sql .= " [DATE_REL], ";
					$sql .= " [DATE_ACKN_LAST], ";
					$sql .= " [DATE_PICK_LAST], ";
					$sql .= " [DATE_BOL_LAST], ";
					$sql .= " [DATE_SHIP_LAST], ";
					$sql .= " [DATE_INVC_LAST], ";
					$sql .= " [ID_INVC_LAST], ";
					$sql .= " [DESCR_SHIP_VIA_LAST], ";
					$sql .= " [ID_SHIP_LAST], ";
					$sql .= " [ID_PRO_BOL_LAST], ";
					$sql .= " [VER_BO], ";
					$sql .= " [FLAG_ACKN], ";
					$sql .= " [FLAG_PICK], ";
					$sql .= " [ID_PICK_SESS], ";
					$sql .= " [FLAG_INVC], ";
					$sql .= " [FLAG_BOL], ";
					$sql .= " [FLAG_TRACK_BIN], ";
					$sql .= " [FLAG_BM_CAPTURE], ";
					$sql .= " [FLAG_COPY_REVW_SF], ";
					$sql .= " [PRICE_OPTION_TOTAL_VP], ";
					$sql .= " [PRICE_OPTION_TOTAL_VP_FC], ";
					$sql .= " [FLAG_DISC_OPTION], ";
					$sql .= " [COST_OPTION_TOTAL_VP], ";
					$sql .= " [COST_OPTION_TOTAL_VP_FC], ";
					$sql .= " [WGT_OPTION_TOTAL], ";
					$sql .= " [ID_LOC_SO], ";
					$sql .= " [ID_SO], ";
					$sql .= " [SUFX_SO], ";
					$sql .= " [RATIO_STK_PRICE], ";
					$sql .= " [CODE_UM_PRICE], ";
					$sql .= " [RATIO_PRICE_SELL], ";
					$sql .= " [DATE_CUTOFF_ALLOC], ";
					$sql .= " [FLAG_SCHD_SHIP], ";
					$sql .= " [CODE_FRT], ";
					$sql .= " [WGT_SHIP_TOTAL], ";
					$sql .= " [FLAG_POST], ";
					$sql .= " [QTY_CARTON_PER], ";
					$sql .= " [QTY_ALLOC], ";
					$sql .= " [FLAG_CUM_MNT], ";
					$sql .= " [YR_MODEL], ";
					$sql .= " [ID_LINE_PO_EDI], ";
					$sql .= " [ID_PO_CUST_CARAS], ";
					$sql .= " [FLAG_OPTION_ATPIC], ";
					$sql .= " [FLAG_BO], ";
					$sql .= " [PCT_CMPL_ATPIC], ";
					$sql .= " [RATE_EXCHG_CRNCY], ";
					$sql .= " [CODE_CAT_COST], ";
					$sql .= " [REL_830], ";
					$sql .= " [YR_MODEL_ALT], ";
					$sql .= " [CLASS_DEST], ";
					$sql .= " [REF], ";
					$sql .= " [CODE_CONT], ";
					$sql .= " [QTY_CONT_PER], ";
					$sql .= " [QTY_CONT_1], ";
					$sql .= " [QTY_CONT_LAST], ";
					$sql .= " [QTY_CONT_2], ";
					$sql .= " [ID_QUOTE], ";
					$sql .= " [SEQ_REV_QUOTE], ";
					$sql .= " [ID_EST], ";
					$sql .= " [SEQ_JOB], ";
					$sql .= " [ATTACH_COMMENT], ";
					$sql .= " [ORG_ITEM], ";
					$sql .= " [FLAG_LINE_SHIP_FROM], ";
					$sql .= " [CODE_FEE_RESTOCK], ";
					$sql .= " [CALC_FEE_RESTOCK_VP], ";
					$sql .= " [AMT_FEE_RESTOCK], ";
					$sql .= " [AMT_FEE_RESTOCK_FC], ";
					$sql .= " [ID_PO], ";
					$sql .= " [ID_REL_ORD], ";
					$sql .= " [ID_LINE_PO], ";
					$sql .= " [CODE_TAX_PROD_CODE], ";
					$sql .= " [SEQ_QTE_LIN], ";
					$sql .= " [rowid] as ORIG_rowid, ";
					$sql .= " GetDate() as DATETIME_SNAPSHOT ";
					//$sql .= " '".$arrayDates[$x]."' as DATETIME_SNAPSHOT ";
					$sql .= " FROM nsa.CP_ORDLIN";
					//$sql .= "_".$arrayDates[$x];
					QueryDatabase($sql, $results);
				//}

				error_log("### runMONTHLY_OPEN_ORDERS_SNAPSHOT DELETING flag in RUNNING_PROC " . date('Y-m-d g:i:s a'));
				error_log("### LAST INSERT ID: " . $ProcRowID);

				$sql  = "DELETE FROM nsa.RUNNING_PROC ";
				$sql .= " WHERE ";
				$sql .= " rowid = " . $ProcRowID;
				QueryDatabase($sql, $results);

			} else {
				// FUTURE ENHANCEMENT -- Sleep and reloop
				error_log("### runMONTHLY_OPEN_ORDERS_SNAPSHOT ALREADY RUNNING flag in RUNNING_PROC " . date('Y-m-d g:i:s a'));
			}

			error_log("### runMONTHLY_OPEN_ORDERS_SNAPSHOT finished at " . date('Y-m-d g:i:s a'));
			error_log("#############################################");
		}
		$retval = DisconnectFromDatabaseServer($db);
		if ($retval == 0) {
			error_log("runMONTHLY_OPEN_ORDERS_SNAPSHOT cannot disconnect from database");
		}
	}
?>
